<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobil Barcode & QR Ayırıcı</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .app-container {
            max-width: 100vw;
            margin: 0;
            background: rgba(255, 255, 255, 0.98);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px 15px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tab-navigation {
            display: flex;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 15px 10px;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
            background: rgba(79, 172, 254, 0.05);
        }

        .tab-content {
            flex: 1;
            padding: 20px 15px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-section {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stats-title {
            font-size: 1.1em;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .stat-item:active {
            transform: scale(0.98);
        }

        .stat-car {
            font-weight: 700;
            color: #4facfe;
            font-size: 0.85em;
        }

        .stat-count {
            font-size: 1.4em;
            font-weight: 800;
            color: #333;
            margin-top: 5px;
        }

        .zero-boxes {
            color: #dc3545;
        }

        .camera-section {
            margin-bottom: 20px;
        }

        .camera-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
            aspect-ratio: 4/3;
        }

        #camera {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%;
            height: 30%;
            border: 3px solid #00f2fe;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.6);
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0%, 100% { border-color: #00f2fe; }
            50% { border-color: #4facfe; }
        }

        .camera-overlay::before {
            content: 'Kodu buraya hizalayın';
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            color: #00f2fe;
            font-size: 12px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.7);
            white-space: nowrap;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .controls.three-btn {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .btn {
            padding: 15px 10px;
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 50px;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-remove {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            color: white;
        }

        .btn-generate {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #333;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .results-header h3 {
            color: #333;
            font-size: 1.2em;
            font-weight: 700;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .clear-btn:active {
            transform: scale(0.95);
        }

        .current-scan {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scan-result {
            color: #333;
            font-size: 1em;
            font-weight: 700;
        }

        .scan-empty {
            color: #666;
            font-style: italic;
            font-size: 0.9em;
        }

        .history {
            max-height: 250px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .history-item {
            background: white;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .barcode-raw {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            color: #666;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .barcode-parsed {
            color: #333;
            font-weight: 700;
            font-size: 14px;
        }

        .timestamp {
            color: #999;
            font-size: 11px;
            margin-top: 5px;
        }

        .qr-generator {
            text-align: center;
        }

        .qr-form {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            -webkit-appearance: none;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .qr-display {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        #qrCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            font-weight: 700;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .modal-submit {
            background: #4facfe;
            color: white;
        }

        .modal-cancel {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .modal-btn:active {
            transform: scale(0.98);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
            font-size: 14px;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
            font-size: 14px;
        }

        /* iOS Safari özel stilleri */
        @supports (-webkit-touch-callout: none) {
            .btn {
                -webkit-appearance: none;
                -webkit-touch-callout: none;
            }
        }

        /* Küçük ekranlar için iyileştirmeler */
        @media (max-width: 360px) {
            .header {
                padding: 15px 10px 10px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .tab-content {
                padding: 15px 10px;
            }
            
            .btn {
                font-size: 12px;
                padding: 12px 8px;
                min-height: 45px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Landscape modda kamera optimizasyonu */
        @media (orientation: landscape) and (max-height: 500px) {
            .camera-container {
                aspect-ratio: 16/9;
            }
            
            .camera-overlay {
                width: 40%;
                height: 50%;
            }
        }

        .floating-action {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
            z-index: 99;
            transition: all 0.3s ease;
        }

        .floating-action:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>📱 Mobil Barcode & QR</h1>
            <p>Okuyun, oluşturun ve paylaşın</p>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="scanner">📷 Tarayıcı</button>
            <button class="tab-btn" data-tab="generator">🎯 QR Oluştur</button>
            <button class="tab-btn" data-tab="stats">📊 İstatistik</button>
        </div>

        <!-- Tarayıcı Tab -->
        <div class="tab-content active" id="scanner">
            <div class="camera-section">
                <div class="camera-container">
                    <div id="camera"></div>
                    <div class="camera-overlay"></div>
                </div>
                
                <div class="controls three-btn">
                    <button class="btn btn-start" id="startBtn">
                        📹 Başlat
                    </button>
                    <button class="btn btn-stop" id="stopBtn" disabled>
                        ⏹️ Durdur
                    </button>
                    <button class="btn btn-remove" id="removeBtn">
                        ➖ Çıkar
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h3>📊 Sonuçlar</h3>
                    <button class="clear-btn" id="clearBtn">🗑️ Temizle</button>
                </div>

                <div class="current-scan">
                    <div id="currentResult" class="scan-empty">
                        Barcode/QR taramaya hazır...
                    </div>
                </div>

                <div class="history" id="history">
                    <!-- Geçmiş sonuçlar buraya eklenecek -->
                </div>
            </div>
        </div>

        <!-- QR Generator Tab -->
        <div class="tab-content" id="generator">
            <div class="qr-generator">
                <div class="qr-form">
                    <div class="form-group">
                        <label class="form-label">Araç Numarası</label>
                        <select class="form-select" id="carSelect">
                            <option value="1">1. Araç</option>
                            <option value="2">2. Araç</option>
                            <option value="3">3. Araç</option>
                            <option value="4">4. Araç</option>
                            <option value="5">5. Araç</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Kutu Numarası</label>
                        <input type="number" class="form-input" id="boxNumber" placeholder="Kutu numarasını girin" min="1" max="999">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Yıl (İsteğe bağlı)</label>
                        <input type="number" class="form-input" id="yearInput" placeholder="2024" min="2020" max="2030">
                    </div>
                </div>

                <button class="btn btn-generate" id="generateBtn">
                    🎯 QR Code Oluştur
                </button>

                <div class="qr-display" id="qrDisplay" style="display: none;">
                    <canvas id="qrCanvas"></canvas>
                    <div style="margin-top: 15px; color: #666; font-size: 14px;">
                        <div>Kod: <span id="generatedCode"></span></div>
                        <div style="margin-top: 5px; font-size: 12px;">Bu QR kodu başka bir telefonla okutarak kutuyu araca ekleyebilirsiniz</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- İstatistik Tab -->
        <div class="tab-content" id="stats">
            <div class="stats-section">
                <div class="stats-title">📊 Araç Kutu İstatistikleri</div>
                <div class="stats-grid" id="statsGrid">
                    <!-- İstatistikler buraya eklenecek -->
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h3>📋 Son İşlemler</h3>
                </div>
                <div class="history" id="statsHistory">
                    <!-- Son işlemler buraya eklenecek -->
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>🔐 Kutu Çıkarma</h3>
            <input type="password" class="modal-input" id="passwordInput" placeholder="Şifreyi girin">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="passwordCancel">İptal</button>
                <button class="modal-btn modal-submit" id="passwordSubmit">Onayla</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action" id="fabBtn" title="Vibrasyon">📳</button>

    <script>
        let isScanning = false;
        let scanHistory = [];
        let db;
        let currentBarcode = null;
        let vibrationEnabled = true;
        const PASSWORD = "123";

        // HTML elementleri
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const removeBtn = document.getElementById('removeBtn');
        const currentResult = document.getElementById('currentResult');
        const historyDiv = document.getElementById('history');
        const statsGrid = document.getElementById('statsGrid');
        const statsHistory = document.getElementById('statsHistory');
        const passwordModal = document.getElementById('passwordModal');
        const passwordInput = document.getElementById('passwordInput');
        const passwordCancel = document.getElementById('passwordCancel');
        const passwordSubmit = document.getElementById('passwordSubmit');
        const generateBtn = document.getElementById('generateBtn');
        const qrDisplay = document.getElementById('qrDisplay');
        const qrCanvas = document.getElementById('qrCanvas');
        const generatedCode = document.getElementById('generatedCode');
        const carSelect = document.getElementById('carSelect');
        const boxNumber = document.getElementById('boxNumber');
        const yearInput = document.getElementById('yearInput');
        const fabBtn = document.getElementById('fabBtn');

        // Tab sistem
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                
                // Aktif tab'ı değiştir
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tabId).classList.add('active');

                // Kamerayı durdur
                if (tabId !== 'scanner' && isScanning) {
                    stopScanning();
                }

                // İstatistikleri güncelle
                if (tabId === 'stats') {
                    loadStats();
                    loadStatsHistory();
                }
            });
        });

        // Vibrasyon kontrolü
        fabBtn.addEventListener('click', () => {
            vibrationEnabled = !vibrationEnabled;
            fabBtn.textContent = vibrationEnabled ? '📳' : '📴';
            showMessage(vibrationEnabled ? 'Vibrasyon açık' : 'Vibrasyon kapalı', 'success');
        });

        // Veritabanı başlatma
        function initDatabase() {
            const config = {
                locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${filename}`
            };
            
            initSqlJs(config).then(SQL => {
                db = new SQL.Database();
                
                db.run(`
                    CREATE TABLE IF NOT EXISTS cars (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        car_number INTEGER NOT NULL,
                        box_count INTEGER DEFAULT 0,
                        last_updated TEXT
                    );
                `);
                
                db.run(`
                    CREATE TABLE IF NOT EXISTS history (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        raw_code TEXT NOT NULL,
                        parsed_code TEXT NOT NULL,
                        timestamp TEXT NOT NULL,
                        operation_type TEXT NOT NULL
                    );
                `);
                
                // Başlangıç verileri
                const checkData = db.exec("SELECT COUNT(*) as count FROM cars");
                if (checkData[0].values[0][0] === 0) {
                    for (let i = 1; i <= 5; i++) {
                        db.run("INSERT INTO cars (car_number, box_count, last_updated) VALUES (?, 0, datetime('now'))", [i]);
                    }
                    
                    db.run(`INSERT INTO history (raw_code, parsed_code, timestamp, operation_type) 
                           VALUES ('SISTEM', 'Mobil uygulama başlatıldı', datetime('now'), 'system')`);
                }
                
                loadStats();
                loadHistory();
            }).catch(err => {
                console.error('Veritabanı hatası:', err);
                showMessage('❌ Veritabanı başlatılamadı', 'error');
            });
        }

        function showMessage(message, type = 'success') {
            const className = type === 'error' ? 'error-message' : 'success-message';
            currentResult.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                if (currentResult.innerHTML.includes(message)) {
                    currentResult.innerHTML = '<div class="scan-empty">Tarama bekleniyor...</div>';
                }
            }, 3000);
        }

        function loadStats() {
            const results = db.exec("SELECT car_number, box_count FROM cars ORDER BY car_number");
            if (results.length === 0) return;
            
            const cars = results[0].values;
            statsGrid.innerHTML = cars.map(car => `
                <div class="stat-item">
                    <div class="stat-car">${car[0]}. Araç</div>
                    <div class="stat-count ${car[1] === 0 ? 'zero-boxes' : ''}">${car[1]} Kutu</div>
                </div>
            `).join('');
        }

        function loadHistory() {
            const results = db.exec("SELECT raw_code, parsed_code, timestamp FROM history ORDER BY timestamp DESC LIMIT 20");
            if (results.length === 0) return;
            
            scanHistory = results[0].values.map(row => ({
                raw: row[0],
                parsed: row[1],
                time: new Date(row[2]).toLocaleTimeString('tr-TR')
            }));
            
            updateHistoryDisplay();
        }

        function loadStatsHistory() {
            const results = db.exec("SELECT raw_code, parsed_code, timestamp, operation_type FROM history ORDER BY timestamp DESC LIMIT 10");
            if (results.length === 0) return;
            
            statsHistory.innerHTML = results[0].values.map(row => {
                const icon = row[3] === 'add' ? '➕' : row[3] === 'remove' ? '➖' : '🔄';
                return `
                    <div class="history-item">
                        <div class="barcode-raw">${row[0] === 'SISTEM' ? 'Sistem Mesajı' : 'Kod: ' + row[0]}</div>
                        <div class="barcode-parsed">${icon} ${row[1]}</div>
                        <div class="timestamp">${new Date(row[2]).toLocaleTimeString('tr-TR')}</div>
                    </div>
                `;
            }).join('');
        }

        function parseBarcode(code) {
            if (code.length >= 4) {
                const year = code.substring(0, 2);
                const carNumber = code.substring(2, 3);
                const boxNumber = code.substring(3);
                
                return `${carNumber}. Araç, ${boxNumber}. Kutu (20${year})`;
            } else if (code.length === 3) {
                const carNumber = code.substring(0, 1);
                const boxNumber = code.substring(1);
                return `${carNumber}. Araç, ${boxNumber}. Kutu`;
            } else {
                return `Kategori: ${code}`;
            }
        }

        function addToHistory(rawCode, parsedCode, operation = 'add') {
            const timestamp = new Date().toISOString();
            
            db.run(
                "INSERT INTO history (raw_code, parsed_code, timestamp, operation_type) VALUES (?, ?, ?, ?)",
                [rawCode, parsedCode, timestamp, operation]
            );
            
            if (operation === 'add' && rawCode.length >= 3) {
                const carNumber = parseInt(rawCode.substring(0, 3).replace(/[^0-9]/g, '').charAt(0));
                if (!isNaN(carNumber) && carNumber >= 1 && carNumber <= 5) {
                    const check = db.exec("SELECT 1 FROM cars WHERE car_number = ?", [carNumber]);
                    if (check[0] && check[0].values.length > 0) {
                        db.run(
                            "UPDATE cars SET box_count = box_count + 1, last_updated = ? WHERE car_number = ?",
                            [timestamp, carNumber]
                        );
                    } else {
                        db.run(
                            "INSERT INTO cars (car_number, box_count, last_updated) VALUES (?, 1, ?)",
                            [carNumber, timestamp]
                        );
                    }
                    loadStats();
                }
            }
            
            loadHistory();
        }

        function removeBox(rawCode, parsedCode) {
            if (rawCode.length >= 3) {
                const carNumber = parseInt(rawCode.substring(0, 3).replace(/[^0-9]/g, '').charAt(0));
                if (!isNaN(carNumber) && carNumber >= 1 && carNumber <= 5) {
                    const check = db.exec("SELECT box_count FROM cars WHERE car_number = ?", [carNumber]);
                    if (check[0] && check[0].values.length > 0) {
                        if (check[0].values[0][0] <= 0) {
                            showMessage(`❌ ${carNumber}. Araçta kutu kalmadı!`, 'error');
                            return false;
                        }
                        
                        const timestamp = new Date().toISOString();
                        db.run(
                            "UPDATE cars SET box_count = box_count - 1, last_updated = ? WHERE car_number = ?",
                            [timestamp, carNumber]
                        );
                        
                        addToHistory(rawCode, parsedCode, 'remove');
                        
                        showMessage(`✅ Kutu çıkarıldı: ${parsedCode}`, 'success');
                        loadStats();
                        return true;
                    }
                }
            }
            
            showMessage('❌ Kutu çıkarılamadı: Geçersiz barkod', 'error');
            return false;
        }

        function updateHistoryDisplay() {
            historyDiv.innerHTML = scanHistory.map(item => `
                <div class="history-item">
                    <div class="barcode-raw">${item.raw === 'SISTEM' ? 'Sistem Mesajı' : 'Ham Kod: ' + item.raw}</div>
                    <div class="barcode-parsed">${item.parsed}</div>
                    <div class="timestamp">${item.time}</div>
                </div>
            `).join('');
        }

        function startScanning() {
            if (isScanning) return;

            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#camera'),
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment"
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: navigator.hardwareConcurrency || 2,
                decoder: {
                    readers: [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "code_39_vin_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader",
                        "qr_reader"
                    ]
                },
                locate: true
            }, function(err) {
                if (err) {
                    console.error('Kamera başlatılamadı:', err);
                    showMessage('❌ Kamera erişimi sağlanamadı', 'error');
                    return;
                }
                
                isScanning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                currentResult.innerHTML = '<div class="scan-result"><span class="status-indicator"></span>Kod aranıyor...</div>';
                
                Quagga.start();
            });
        }

        function stopScanning() {
            if (!isScanning) return;
            
            Quagga.stop();
            isScanning = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            currentResult.innerHTML = '<div class="scan-empty">Tarama durduruldu</div>';
        }

        function generateQRCode() {
            const car = carSelect.value;
            const box = boxNumber.value;
            const year = yearInput.value;
            
            if (!box) {
                showMessage('❌ Kutu numarası gerekli', 'error');
                return;
            }
            
            let code = '';
            if (year) {
                code = year.substring(2) + car + box.padStart(2, '0');
            } else {
                code = car + box.padStart(2, '0');
            }
            
            // QR Code oluştur
            const qr = new QRious({
                element: qrCanvas,
                value: code,
                size: 250,
                background: 'white',
                foreground: '#333',
                level: 'H'
            });
            
            generatedCode.textContent = code;
            qrDisplay.style.display = 'block';
            
            showMessage(`✅ QR Code oluşturuldu: ${parseBarcode(code)}`, 'success');
        }

        // Event Listeners
        startBtn.addEventListener('click', startScanning);
        stopBtn.addEventListener('click', stopScanning);
        
        clearBtn.addEventListener('click', () => {
            if (confirm('Tüm geçmiş ve kutu sayıları silinecek. Emin misiniz?')) {
                db.run("DELETE FROM history");
                db.run("UPDATE cars SET box_count = 0, last_updated = datetime('now')");
                loadHistory();
                loadStats();
                loadStatsHistory();
                showMessage('✅ Veriler temizlendi', 'success');
            }
        });

        removeBtn.addEventListener('click', () => {
            if (!currentBarcode) {
                showMessage('❌ Önce bir kod tarayın', 'error');
                return;
            }
            
            passwordModal.style.display = 'flex';
            passwordInput.focus();
        });

        passwordCancel.addEventListener('click', () => {
            passwordModal.style.display = 'none';
            passwordInput.value = '';
        });

        passwordSubmit.addEventListener('click', () => {
            if (passwordInput.value === PASSWORD) {
                passwordModal.style.display = 'none';
                passwordInput.value = '';
                
                const parsedCode = parseBarcode(currentBarcode);
                removeBox(currentBarcode, parsedCode);
            } else {
                showMessage('❌ Hatalı şifre!', 'error');
                passwordInput.value = '';
            }
        });

        generateBtn.addEventListener('click', generateQRCode);

        // Enter tuşu ile şifre onaylama
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                passwordSubmit.click();
            }
        });

        // QR/Barcode algılama
        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            currentBarcode = code;
            const parsedCode = parseBarcode(code);
            
            currentResult.innerHTML = `
                <div class="scan-result">
                    <div style="color: #28a745; font-size: 1.2em;">✅ ${parsedCode}</div>
                    <div style="color: #666; font-size: 0.8em; margin-top: 5px;">Kod: ${code}</div>
                </div>
            `;
            
            addToHistory(code, parsedCode);
            
            // Vibrasyon
            if (vibrationEnabled && navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // Ses efekti (opsiyonel)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+L2um4gAz2V3vPJeSsFJXfH8N2QQAoUXrTp66hVFApGn+L2um4gAz2V3vPJeSsFJXfH8N2QQAoUXrTp66hVFApGn+L2um4gAz2V3vPJeSsFJXfH8N2QQAoUXrTp66hVFApGn+L2um4gAz2V3vPJeSsFJXfH8N2QQAoUXrTp66hVFApGn+L2um4gAz2V3vPJeSsFJXfH8N2QQAoUXrTp66hVFApGn+L2um4gAz2V3vPJeSsFJXfH8N2QQAoUXrTp66hVFApGn');
                audio.play().catch(() => {});
            } catch (e) {}
        });

        // Sayfa yüklendiğinde
        window.addEventListener('load', () => {
            initDatabase();
            
            // Yıl inputuna varsayılan değer
            yearInput.value = new Date().getFullYear();
            
            // PWA desteği
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:text/javascript,').catch(() => {});
            }
        });

        // Sayfa kapanırken kamerayı durdur
        window.addEventListener('beforeunload', () => {
            if (isScanning) {
                stopScanning();
            }
        });

        // Görünürlük değiştiğinde
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isScanning) {
                stopScanning();
            }
        });

        // Dokunmatik klavye problemini çözmek için
        window.addEventListener('resize', () => {
            if (document.activeElement.tagName === 'INPUT') {
                setTimeout(() => {
                    document.activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
            }
        });
    </script>
</body>
</html>
