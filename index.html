<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- iOS için gerekli meta etiketi -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mobil QR Code Ayırıcı</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .app-container {
            max-width: 100vw;
            margin: 0;
            background: rgba(255, 255, 255, 0.98);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 18px 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.6rem;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .header p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .tab-navigation {
            display: flex;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 14px 8px;
            border: none;
            background: transparent;
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #4facfe;
            border-bottom-color: #4facfe;
        }

        .tab-content {
            flex: 1;
            padding: 16px;
            display: none;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        .stats-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .stats-title {
            font-size: 1.1rem;
            margin-bottom: 14px;
            color: #333;
            text-align: center;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            transition: transform 0.15s ease;
        }

        .stat-item:active {
            transform: scale(0.97);
        }

        .stat-car {
            font-weight: 700;
            color: #4facfe;
            font-size: 0.8rem;
        }

        .stat-count {
            font-size: 1.3rem;
            font-weight: 800;
            color: #333;
            margin-top: 4px;
        }

        .zero-boxes {
            color: #dc3545;
        }

        .camera-section {
            margin-bottom: 16px;
        }

        .camera-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 14px;
            aspect-ratio: 1/1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* iPhone için kamera yönlendirme düzeltmesi */
            transform: none;
        }

        /* Ön kamera kullanıldığında mirror effect uygula */
        #video.front-camera {
            transform: scaleX(-1);
        }

        /* Arka kamera kullanıldığında normal görünüm */
        #video.back-camera {
            transform: none;
        }

        .qr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            height: 70%;
            border: 3px solid rgba(0, 242, 254, 0.8);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 242, 254, 0.5);
            animation: qr-pulse 2s infinite;
            pointer-events: none;
        }

        .qr-overlay::before {
            content: 'QR kodu buraya hizalayın';
            position: absolute;
            top: -32px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            white-space: nowrap;
            background: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 12px;
        }

        @keyframes qr-pulse {
            0%, 100% {
                border-color: rgba(0, 242, 254, 0.8);
                box-shadow: 0 0 20px rgba(0, 242, 254, 0.5);
            }
            50% {
                border-color: rgba(79, 172, 254, 0.8);
                box-shadow: 0 0 30px rgba(79, 172, 254, 0.6);
            }
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .controls.three-btn {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .btn {
            padding: 14px 10px;
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 48px;
        }

        .btn-start {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-remove {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
            color: white;
        }

        .btn-generate {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: #333;
        }

        .btn:active {
            transform: scale(0.97);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .results-header h3 {
            color: #333;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .clear-btn:active {
            transform: scale(0.95);
        }

        .current-scan {
            background: linear-gradient(135deg, rgba(132, 250, 176, 0.2) 0%, rgba(143, 211, 244, 0.2) 100%);
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 14px;
            text-align: center;
            min-height: 76px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #84fab0;
        }

        .scan-result {
            color: #333;
            font-size: 0.95rem;
            font-weight: 700;
        }

        .scan-empty {
            color: #666;
            font-style: italic;
            font-size: 0.85rem;
        }

        .history {
            max-height: 220px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #4facfe #f1f1f1;
        }

        .history::-webkit-scrollbar {
            width: 6px;
        }

        .history::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .history::-webkit-scrollbar-thumb {
            background: #4facfe;
            border-radius: 3px;
        }

        .history-item {
            background: white;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            transition: transform 0.15s ease;
        }

        .history-item:active {
            transform: scale(0.98);
        }

        .qr-raw {
            font-family: monospace;
            color: #666;
            font-size: 0.75rem;
            margin-bottom: 4px;
            word-break: break-all;
        }

        .qr-parsed {
            color: #333;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .timestamp {
            color: #999;
            font-size: 0.7rem;
            margin-top: 4px;
        }

        .qr-generator {
            text-align: center;
        }

        .qr-form {
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 12px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .qr-display {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        #qrCanvas {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .qr-info {
            margin-top: 12px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(230, 243, 255, 0.5) 0%, rgba(204, 231, 255, 0.5) 100%);
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .qr-code-text {
            font-family: monospace;
            font-size: 0.95rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .qr-description {
            color: #666;
            font-size: 0.75rem;
            line-height: 1.4;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 100%;
            max-width: 320px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            animation: modal-fade 0.3s ease;
        }

        @keyframes modal-fade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal h3 {
            margin-bottom: 16px;
            color: #333;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .modal-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.95rem;
            text-align: center;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .modal-submit {
            background: #4facfe;
            color: white;
        }

        .modal-cancel {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e9ecef;
        }

        .modal-btn:active {
            transform: scale(0.97);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 8px rgba(40, 167, 69, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #f5c6cb;
            font-size: 0.85rem;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border: 1px solid #c3e6cb;
            font-size: 0.85rem;
        }

        .floating-action {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
            z-index: 99;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .floating-action:active {
            transform: scale(0.95);
        }

        .camera-switch {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .torch-control {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive adjustments */
        @media (max-width: 360px) {
            .header {
                padding: 14px 10px;
            }
            
            .header h1 {
                font-size: 1.4rem;
            }
            
            .tab-content {
                padding: 12px 10px;
            }
            
            .btn {
                font-size: 0.8rem;
                padding: 12px 6px;
                min-height: 44px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .camera-container {
                aspect-ratio: 4/3;
            }
            
            .qr-overlay {
                width: 50%;
                height: 70%;
            }
        }

        /* iOS Safari için özel optimizasyonlar */
        @supports (-webkit-touch-callout: none) {
            .camera-container {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            
            #video {
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            
            #video.front-camera {
                -webkit-transform: scaleX(-1) translateZ(0);
                transform: scaleX(-1) translateZ(0);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>🔳 Mobil QR Code</h1>
            <p>QR kodlarını okuyun, oluşturun ve paylaşın</p>
        </div>

        <div class="tab-navigation">
            <button class="tab-btn active" data-tab="scanner">📷 Tarayıcı</button>
            <button class="tab-btn" data-tab="generator">🎯 Oluştur</button>
            <button class="tab-btn" data-tab="stats">📊 İstatistik</button>
        </div>

        <!-- QR Tarayıcı Tab -->
        <div class="tab-content active" id="scanner">
            <div class="camera-section">
                <div class="camera-container">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                    <div class="qr-overlay"></div>
                    <button class="camera-switch" id="switchBtn" title="Kamera Değiştir">🔄</button>
                    <button class="torch-control" id="torchBtn" title="Flaş Aç/Kapat">🔦</button>
                </div>
                
                <div class="controls three-btn">
                    <button class="btn btn-start" id="startBtn">
                        📹 Başlat
                    </button>
                    <button class="btn btn-stop" id="stopBtn" disabled>
                        ⏹️ Durdur
                    </button>
                    <button class="btn btn-remove" id="removeBtn">
                        ➖ Çıkar
                    </button>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h3>📊 Sonuçlar</h3>
                    <button class="clear-btn" id="clearBtn">🗑️ Temizle</button>
                </div>

                <div class="current-scan">
                    <div id="currentResult" class="scan-empty">
                        QR kod taramaya hazır...
                    </div>
                </div>

                <div class="history" id="history">
                    <!-- Geçmiş sonuçlar buraya eklenecek -->
                </div>
            </div>
        </div>

        <!-- QR Generator Tab -->
        <div class="tab-content" id="generator">
            <div class="qr-generator">
                <div class="qr-form">
                    <div class="form-group">
                        <label class="form-label">🚗 Araç Numarası</label>
                        <select class="form-select" id="carSelect">
                            <option value="1">1. Araç</option>
                            <option value="2">2. Araç</option>
                            <option value="3">3. Araç</option>
                            <option value="4">4. Araç</option>
                            <option value="5">5. Araç</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">📦 Kutu Numarası</label>
                        <input type="number" class="form-input" id="boxNumber" placeholder="Kutu numarasını girin" min="1" max="999">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">📅 Yıl (İsteğe bağlı)</label>
                        <input type="number" class="form-input" id="yearInput" placeholder="2024" min="2020" max="2030">
                    </div>
                </div>

                <button class="btn btn-generate" id="generateBtn">
                    🎯 QR Kod Oluştur
                </button>

                <div class="qr-display" id="qrDisplay" style="display: none;">
                    <canvas id="qrCanvas"></canvas>
                    <div class="qr-info">
                        <div class="qr-code-text" id="generatedCode"></div>
                        <div class="qr-description">
                            Bu QR kodu başka bir telefonla okutarak kutuyu araca ekleyebilirsiniz.
                            QR kod yüksek hata düzeltme seviyesi ile oluşturulmuştur.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- İstatistik Tab -->
        <div class="tab-content" id="stats">
            <div class="stats-section">
                <div class="stats-title">📊 Araç Kutu İstatistikleri</div>
                <div class="stats-grid" id="statsGrid">
                    <!-- İstatistikler buraya eklenecek -->
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h3>📋 Son İşlemler</h3>
                </div>
                <div class="history" id="statsHistory">
                    <!-- Son işlemler buraya eklenecek -->
                </div>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h3>🔐 Kutu Çıkarma</h3>
            <input type="password" class="modal-input" id="passwordInput" placeholder="Şifreyi girin" autocomplete="off">
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" id="passwordCancel">İptal</button>
                <button class="modal-btn modal-submit" id="passwordSubmit">Onayla</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="floating-action" id="fabBtn" title="Vibrasyon">📳</button>

    <script>
        // State management
        const state = {
            isScanning: false,
            scanHistory: [],
            db: null,
            currentQRCode: null,
            vibrationEnabled: true,
            currentStream: null,
            facingMode: 'environment', // 'environment' or 'user'
            torchEnabled: false,
            scanInterval: null,
            lastScannedCode: null,
            lastScanTime: 0
        };

        // DOM Elements
        const elements = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearBtn: document.getElementById('clearBtn'),
            removeBtn: document.getElementById('removeBtn'),
            currentResult: document.getElementById('currentResult'),
            historyDiv: document.getElementById('history'),
            statsGrid: document.getElementById('statsGrid'),
            statsHistory: document.getElementById('statsHistory'),
            passwordModal: document.getElementById('passwordModal'),
            passwordInput: document.getElementById('passwordInput'),
            passwordCancel: document.getElementById('passwordCancel'),
            passwordSubmit: document.getElementById('passwordSubmit'),
            generateBtn: document.getElementById('generateBtn'),
            qrDisplay: document.getElementById('qrDisplay'),
            qrCanvas: document.getElementById('qrCanvas'),
            generatedCode: document.getElementById('generatedCode'),
            carSelect: document.getElementById('carSelect'),
            boxNumber: document.getElementById('boxNumber'),
            yearInput: document.getElementById('yearInput'),
            fabBtn: document.getElementById('fabBtn'),
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            switchBtn: document.getElementById('switchBtn'),
            torchBtn: document.getElementById('torchBtn'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content')
        };

        // Constants
        const PASSWORD = "123";
        const SCAN_COOLDOWN = 2000; // 2 seconds between scans
        const DEBOUNCE_TIME = 500; // 500ms debounce for same code

        // Initialize the app
        function initApp() {
            initDatabase();
            setupEventListeners();
            
            // Set current year as default
            elements.yearInput.value = new Date().getFullYear();
            
            // Try to register service worker for PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            }
        }

        // Initialize SQL.js database
        function initDatabase() {
            const config = {
                locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${filename}`
            };
            
            initSqlJs(config).then(SQL => {
                state.db = new SQL.Database();
                
                // Create tables if they don't exist
                state.db.run(`
                    CREATE TABLE IF NOT EXISTS cars (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        car_number INTEGER NOT NULL,
                        box_count INTEGER DEFAULT 0,
                        last_updated TEXT
                    );
                `);
                
                state.db.run(`
                    CREATE TABLE IF NOT EXISTS history (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        raw_code TEXT NOT NULL,
                        parsed_code TEXT NOT NULL,
                        timestamp TEXT NOT NULL,
                        operation_type TEXT NOT NULL
                    );
                `);
                
                // Initialize with default data if empty
                const checkData = state.db.exec("SELECT COUNT(*) as count FROM cars");
                if (checkData[0].values[0][0] === 0) {
                    for (let i = 1; i <= 5; i++) {
                        state.db.run(
                            "INSERT INTO cars (car_number, box_count, last_updated) VALUES (?, 0, datetime('now'))", 
                            [i]
                        );
                    }
                    
                    state.db.run(
                        `INSERT INTO history (raw_code, parsed_code, timestamp, operation_type) 
                         VALUES ('SISTEM', 'QR Code uygulaması başlatıldı', datetime('now'), 'system')`
                    );
                }
                
                loadStats();
                loadHistory();
            }).catch(err => {
                console.error('Database error:', err);
                showMessage('❌ Veritabanı başlatılamadı', 'error');
            });
        }

        // Set up all event listeners
        function setupEventListeners() {
            // Tab navigation
            elements.tabBtns.forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Scanner controls
            elements.startBtn.addEventListener('click', startScanning);
            elements.stopBtn.addEventListener('click', stopScanning);
            elements.clearBtn.addEventListener('click', confirmClearData);
            elements.removeBtn.addEventListener('click', promptRemoveBox);
            elements.switchBtn.addEventListener('click', switchCamera);
            elements.torchBtn.addEventListener('click', toggleTorch);

            // Password modal
            elements.passwordCancel.addEventListener('click', closePasswordModal);
            elements.passwordSubmit.addEventListener('click', confirmRemoveBox);
            elements.passwordInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') elements.passwordSubmit.click();
            });
            elements.passwordModal.addEventListener('click', e => {
                if (e.target === elements.passwordModal) closePasswordModal();
            });

            // Generator controls
            elements.generateBtn.addEventListener('click', generateQRCode);

            // Vibration toggle
            elements.fabBtn.addEventListener('click', toggleVibration);

            // Page visibility changes
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // Before page unload
            window.addEventListener('beforeunload', cleanupBeforeUnload);
        }

        // Switch between tabs
        function switchTab(tabId) {
            elements.tabBtns.forEach(b => b.classList.remove('active'));
            elements.tabContents.forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Stop scanning if switching away from scanner
            if (tabId !== 'scanner' && state.isScanning) {
                stopScanning();
            }

            // Load stats when switching to stats tab
            if (tabId === 'stats') {
                loadStats();
                loadStatsHistory();
            }
        }

        // Update video element classes based on camera type
        function updateVideoOrientation() {
            elements.video.classList.remove('front-camera', 'back-camera');
            if (state.facingMode === 'user') {
                elements.video.classList.add('front-camera');
            } else {
                elements.video.classList.add('back-camera');
            }
        }

        // Start camera and QR scanning
        function startScanning() {
            if (state.isScanning) return;

            // Request camera access
            navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: state.facingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            }).then(stream => {
                state.currentStream = stream;
                elements.video.srcObject = stream;
                elements.video.setAttribute('playsinline', true);
                elements.video.play();
                
                // Update video orientation based on camera type
                updateVideoOrientation();
                
                state.isScanning = true;
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
                
                // Show scanning status
                elements.currentResult.innerHTML = `
                    <div class="scan-result">
                        <span class="status-indicator"></span>QR kod aranıyor...
                    </div>
                `;
                
                // Start scanning loop when video is ready
                elements.video.addEventListener('loadedmetadata', () => {
                    elements.canvas.width = elements.video.videoWidth;
                    elements.canvas.height = elements.video.videoHeight;
                    
                    // Start scanning at 10fps
                    state.scanInterval = setInterval(scanQRCode, 100);
                });
                
            }).catch(err => {
                console.error('Camera access error:', err);
                showMessage('❌ Kamera erişimi sağlanamadı', 'error');
            });
        }

        // Stop camera and scanning
        function stopScanning() {
            if (!state.isScanning) return;
            
            // Stop scanning loop
            if (state.scanInterval) {
                clearInterval(state.scanInterval);
                state.scanInterval = null;
            }
            
            // Stop camera stream
            if (state.currentStream) {
                state.currentStream.getTracks().forEach(track => track.stop());
                state.currentStream = null;
            }
            
            // Turn off torch if enabled
            if (state.torchEnabled) {
                toggleTorch(false);
            }
            
            state.isScanning = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            
            elements.currentResult.innerHTML = '<div class="scan-empty">QR kod taraması durduruldu</div>';
        }

        // Scan for QR codes in the video stream
        function scanQRCode() {
            if (!state.isScanning || !elements.video.readyState) return;
            
            const context = elements.canvas.getContext('2d');
            
            // Handle mirror effect for front camera in canvas processing
            if (state.facingMode === 'user') {
                context.save();
                context.scale(-1, 1);
                context.drawImage(elements.video, -elements.canvas.width, 0, elements.canvas.width, elements.canvas.height);
                context.restore();
            } else {
                context.drawImage(elements.video, 0, 0, elements.canvas.width, elements.canvas.height);
            }
            
            const imageData = context.getImageData(0, 0, elements.canvas.width, elements.canvas.height);
            const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert"
            });
            
            if (qrCode) {
                const now = Date.now();
                
                // Debounce same code detection
                if (qrCode.data === state.lastScannedCode && now - state.lastScanTime < DEBOUNCE_TIME) {
                    return;
                }
                
                state.lastScannedCode = qrCode.data;
                state.lastScanTime = now;
                
                handleQRCodeDetected(qrCode.data);
            }
        }

        // Handle detected QR code
        function handleQRCodeDetected(code) {
            state.currentQRCode = code;
            const parsedCode = parseQRCode(code);
            
            // Update UI with detected code
            elements.currentResult.innerHTML = `
                <div class="scan-result">
                    <div style="color: #28a745; font-size: 1.1em;">✅ ${parsedCode}</div>
                    <div style="color: #666; font-size: 0.8em; margin-top: 5px;">QR Kod: ${code}</div>
                </div>
            `;
            
            // Add to history
            addToHistory(code, parsedCode);
            
            // Vibrate if enabled
            if (state.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate([100, 50, 100]);
            }
            
            // Play success sound (if supported)
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU...');
                audio.play().catch(() => {});
            } catch (e) {}
            
            // Cooldown before scanning again
            setTimeout(() => {
                if (state.isScanning) {
                    elements.currentResult.innerHTML = `
                        <div class="scan-result">
                            <span class="status-indicator"></span>QR kod aranıyor...
                        </div>
                    `;
                }
            }, SCAN_COOLDOWN);
        }

        // Switch between front and back camera
        function switchCamera() {
            if (!state.isScanning) return;
            
            state.facingMode = state.facingMode === 'environment' ? 'user' : 'environment';
            
            // Restart scanning with new camera
            stopScanning();
            setTimeout(startScanning, 300);
        }

        // Toggle torch/flashlight
        function toggleTorch(forceState) {
            if (!state.currentStream) return;
            
            const videoTrack = state.currentStream.getVideoTracks()[0];
            if (!videoTrack || !('applyConstraints' in videoTrack)) {
                showMessage('❌ Flaş bu cihazda desteklenmiyor', 'error');
                return;
            }
            
            state.torchEnabled = forceState !== undefined ? forceState : !state.torchEnabled;
            
            videoTrack.applyConstraints({
                advanced: [{ torch: state.torchEnabled }]
            }).then(() => {
                elements.torchBtn.textContent = state.torchEnabled ? '💡' : '🔦';
                elements.torchBtn.style.background = state.torchEnabled ? 
                    'rgba(255, 255, 0, 0.7)' : 'rgba(0, 0, 0, 0.5)';
            }).catch(err => {
                console.error('Torch error:', err);
                state.torchEnabled = false;
                showMessage('❌ Flaş açılamadı', 'error');
            });
        }

        // Toggle vibration feedback
        function toggleVibration() {
            state.vibrationEnabled = !state.vibrationEnabled;
            elements.fabBtn.textContent = state.vibrationEnabled ? '📳' : '📴';
            showMessage(state.vibrationEnabled ? 'Vibrasyon açık' : 'Vibrasyon kapalı', 'success');
            
            // Test vibration
            if (state.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        // Parse QR code into readable format
        function parseQRCode(code) {
            if (code.length >= 4) {
                const year = code.substring(0, 2);
                const carNumber = code.substring(2, 3);
                const boxNumber = code.substring(3);
                
                return `${carNumber}. Araç, ${boxNumber}. Kutu (20${year})`;
            } else if (code.length === 3) {
                const carNumber = code.substring(0, 1);
                const boxNumber = code.substring(1);
                return `${carNumber}. Araç, ${boxNumber}. Kutu`;
            } else {
                return `Kategori: ${code}`;
            }
        }

        // Add scanned code to history
        function addToHistory(rawCode, parsedCode, operation = 'add') {
            const timestamp = new Date().toISOString();
            
            state.db.run(
                "INSERT INTO history (raw_code, parsed_code, timestamp, operation_type) VALUES (?, ?, ?, ?)",
                [rawCode, parsedCode, timestamp, operation]
            );
            
            // Update car stats if this is an add operation
            if (operation === 'add' && rawCode.length >= 3) {
                const carNumber = parseInt(rawCode.substring(0, 3).replace(/[^0-9]/g, '').charAt(0));
                if (!isNaN(carNumber) && carNumber >= 1 && carNumber <= 5) {
                    state.db.run(
                        "UPDATE cars SET box_count = box_count + 1, last_updated = ? WHERE car_number = ?",
                        [timestamp, carNumber]
                    );
                    loadStats();
                }
            }
            
            loadHistory();
        }

        // Prompt for password to remove box
        function promptRemoveBox() {
            if (!state.currentQRCode) {
                showMessage('❌ Önce bir QR kod tarayın', 'error');
                return;
            }
            
            elements.passwordModal.style.display = 'flex';
            elements.passwordInput.focus();
        }

        // Close password modal
        function closePasswordModal() {
            elements.passwordModal.style.display = 'none';
            elements.passwordInput.value = '';
        }

        // Confirm box removal after password check
        function confirmRemoveBox() {
            if (elements.passwordInput.value === PASSWORD) {
                closePasswordModal();
                
                const parsedCode = parseQRCode(state.currentQRCode);
                const success = removeBox(state.currentQRCode, parsedCode);
                
                if (success && state.vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([200, 100, 200]);
                }
            } else {
                showMessage('❌ Hatalı şifre!', 'error');
                elements.passwordInput.value = '';
                
                if (state.vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([300, 100, 100, 100]);
                }
            }
        }

        // Remove box from car
        function removeBox(rawCode, parsedCode) {
            if (rawCode.length >= 3) {
                const carNumber = parseInt(rawCode.substring(0, 3).replace(/[^0-9]/g, '').charAt(0));
                if (!isNaN(carNumber) && carNumber >= 1 && carNumber <= 5) {
                    const check = state.db.exec("SELECT box_count FROM cars WHERE car_number = ?", [carNumber]);
                    if (check[0]?.values[0][0] <= 0) {
                        showMessage(`❌ ${carNumber}. Araçta kutu kalmadı!`, 'error');
                        return false;
                    }
                    
                    const timestamp = new Date().toISOString();
                    state.db.run(
                        "UPDATE cars SET box_count = box_count - 1, last_updated = ? WHERE car_number = ?",
                        [timestamp, carNumber]
                    );
                    
                    addToHistory(rawCode, parsedCode, 'remove');
                    showMessage(`✅ Kutu çıkarıldı: ${parsedCode}`, 'success');
                    loadStats();
                    return true;
                }
            }
            
            showMessage('❌ Kutu çıkarılamadı: Geçersiz QR kod', 'error');
            return false;
        }

        // Confirm clearing all data
        function confirmClearData() {
            if (confirm('Tüm geçmiş ve kutu sayıları silinecek. Emin misiniz?')) {
                state.db.run("DELETE FROM history");
                state.db.run("UPDATE cars SET box_count = 0, last_updated = datetime('now')");
                loadHistory();
                loadStats();
                loadStatsHistory();
                showMessage('✅ Veriler temizlendi', 'success');
                
                if (state.vibrationEnabled && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100, 50, 100]);
                }
            }
        }

        // Load car statistics
        function loadStats() {
            const results = state.db.exec("SELECT car_number, box_count FROM cars ORDER BY car_number");
            if (results.length === 0) return;
            
            const cars = results[0].values;
            elements.statsGrid.innerHTML = cars.map(car => `
                <div class="stat-item">
                    <div class="stat-car">${car[0]}. Araç</div>
                    <div class="stat-count ${car[1] === 0 ? 'zero-boxes' : ''}">${car[1]} Kutu</div>
                </div>
            `).join('');
        }

        // Load scan history
        function loadHistory() {
            const results = state.db.exec(`
                SELECT raw_code, parsed_code, timestamp 
                FROM history 
                ORDER BY timestamp DESC 
                LIMIT 20
            `);
            
            if (results.length === 0) return;
            
            state.scanHistory = results[0].values.map(row => ({
                raw: row[0],
                parsed: row[1],
                time: new Date(row[2]).toLocaleTimeString('tr-TR')
            }));
            
            updateHistoryDisplay();
        }

        // Load stats history
        function loadStatsHistory() {
            const results = state.db.exec(`
                SELECT raw_code, parsed_code, timestamp, operation_type 
                FROM history 
                ORDER BY timestamp DESC 
                LIMIT 10
            `);
            
            if (results.length === 0) return;
            
            elements.statsHistory.innerHTML = results[0].values.map(row => {
                const icon = row[3] === 'add' ? '➕' : row[3] === 'remove' ? '➖' : '🔄';
                return `
                    <div class="history-item">
                        <div class="qr-raw">${row[0] === 'SISTEM' ? 'Sistem Mesajı' : 'QR Kod: ' + row[0]}</div>
                        <div class="qr-parsed">${icon} ${row[1]}</div>
                        <div class="timestamp">${new Date(row[2]).toLocaleTimeString('tr-TR')}</div>
                    </div>
                `;
            }).join('');
        }

        // Update history display
        function updateHistoryDisplay() {
            elements.historyDiv.innerHTML = state.scanHistory.map(item => `
                <div class="history-item">
                    <div class="qr-raw">${item.raw === 'SISTEM' ? 'Sistem Mesajı' : 'QR Kod: ' + item.raw}</div>
                    <div class="qr-parsed">${item.parsed}</div>
                    <div class="timestamp">${item.time}</div>
                </div>
            `).join('');
        }

        // Generate QR code
        function generateQRCode() {
            const car = elements.carSelect.value;
            const box = elements.boxNumber.value;
            const year = elements.yearInput.value;
            
            if (!box) {
                showMessage('❌ Kutu numarası gerekli', 'error');
                return;
            }
            
            let code = '';
            if (year) {
                code = year.substring(2) + car + box.padStart(2, '0');
            } else {
                code = car + box.padStart(2, '0');
            }
            
            // Generate QR code
            const qr = new QRious({
                element: elements.qrCanvas,
                value: code,
                size: 260,
                background: 'white',
                foreground: '#333',
                level: 'H' // High error correction
            });
            
            elements.generatedCode.textContent = code;
            elements.qrDisplay.style.display = 'block';
            
            showMessage(`✅ QR Kod oluşturuldu: ${parseQRCode(code)}`, 'success');
            
            // Vibrate if enabled
            if (state.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        // Show message to user
        function showMessage(message, type = 'success') {
            const className = type === 'error' ? 'error-message' : 'success-message';
            elements.currentResult.innerHTML = `<div class="${className}">${message}</div>`;
            
            setTimeout(() => {
                if (elements.currentResult.innerHTML.includes(message)) {
                    elements.currentResult.innerHTML = '<div class="scan-empty">QR kod taranıyor...</div>';
                }
            }, 3000);
        }

        // Handle page visibility changes
        function handleVisibilityChange() {
            if (document.hidden && state.isScanning) {
                stopScanning();
            }
        }

        // Cleanup before page unload
        function cleanupBeforeUnload() {
            if (state.isScanning) {
                stopScanning();
            }
        }

    </script>
</body>
</html>
